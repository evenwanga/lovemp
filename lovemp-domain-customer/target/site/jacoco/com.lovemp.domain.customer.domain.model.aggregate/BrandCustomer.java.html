<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BrandCustomer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lovemp-domain-customer</a> &gt; <a href="index.source.html" class="el_package">com.lovemp.domain.customer.domain.model.aggregate</a> &gt; <span class="el_source">BrandCustomer.java</span></div><h1>BrandCustomer.java</h1><pre class="source lang-java linenums">package com.lovemp.domain.customer.domain.model.aggregate;

import com.lovemp.common.domain.AggregateRoot;
import com.lovemp.common.util.Assert;
import com.lovemp.common.util.DateTimeUtils;
import com.lovemp.domain.customer.domain.event.BrandCustomerCreatedEvent;
import com.lovemp.domain.customer.domain.event.BrandCustomerStatusChangedEvent;
import com.lovemp.domain.customer.domain.event.BrandCustomerUpdatedEvent;
import com.lovemp.domain.customer.domain.model.valueobject.*;
import com.lovemp.domain.person.domain.model.valueobject.PersonId;
import lombok.Getter;

import java.time.LocalDate;

/**
 * 品牌顾客聚合根
 * 
 * &lt;p&gt;表示自然人与品牌之间的顾客关系&lt;/p&gt;
 */
@Getter
public class BrandCustomer extends AggregateRoot&lt;CustomerRelationId&gt; {
    
    /**
     * 品牌ID
     */
<span class="fc" id="L26">    private String brandId;</span>
    
    /**
     * 自然人ID
     */
<span class="fc" id="L31">    private PersonId personId;</span>
    
    /**
     * 顾客编码
     */
<span class="fc" id="L36">    private CustomerCode customerCode;</span>
    
    /**
     * 顾客类型
     */
<span class="fc" id="L41">    private CustomerType customerType;</span>
    
    /**
     * 关系类型
     */
<span class="fc" id="L46">    private RelationType relationType;</span>
    
    /**
     * 状态
     */
<span class="fc" id="L51">    private CustomerStatus status;</span>
    
    /**
     * 积分
     */
<span class="fc" id="L56">    private Integer points;</span>
    
    /**
     * 等级
     */
<span class="fc" id="L61">    private Integer level;</span>
    
    /**
     * 创建日期
     */
<span class="fc" id="L66">    private LocalDate createDate;</span>
    
    /**
     * 最后更新日期
     */
<span class="fc" id="L71">    private LocalDate lastUpdateDate;</span>
    
    /**
     * 保护构造函数，防止直接实例化
     */
<span class="fc" id="L76">    protected BrandCustomer() {</span>
<span class="fc" id="L77">    }</span>
    
    /**
     * 创建品牌顾客关系
     * 
     * @param id 顾客关系ID
     * @param brandId 品牌ID
     * @param personId 自然人ID
     * @param customerCode 顾客编码
     * @param customerType 顾客类型
     * @param relationType 关系类型
     * @return 品牌顾客实例
     */
    public static BrandCustomer create(CustomerRelationId id, String brandId, PersonId personId,
                                     CustomerCode customerCode, CustomerType customerType,
                                     RelationType relationType) {
<span class="fc" id="L93">        Assert.notNull(id, &quot;顾客关系ID不能为空&quot;);</span>
<span class="fc" id="L94">        Assert.notEmpty(brandId, &quot;品牌ID不能为空&quot;);</span>
<span class="fc" id="L95">        Assert.notNull(personId, &quot;自然人ID不能为空&quot;);</span>
<span class="fc" id="L96">        Assert.notNull(customerCode, &quot;顾客编码不能为空&quot;);</span>
<span class="fc" id="L97">        Assert.notNull(customerType, &quot;顾客类型不能为空&quot;);</span>
<span class="fc" id="L98">        Assert.notNull(relationType, &quot;关系类型不能为空&quot;);</span>
        
<span class="fc" id="L100">        BrandCustomer customer = new BrandCustomer();</span>
<span class="fc" id="L101">        customer.id = id;</span>
<span class="fc" id="L102">        customer.brandId = brandId;</span>
<span class="fc" id="L103">        customer.personId = personId;</span>
<span class="fc" id="L104">        customer.customerCode = customerCode;</span>
<span class="fc" id="L105">        customer.customerType = customerType;</span>
<span class="fc" id="L106">        customer.relationType = relationType;</span>
<span class="fc" id="L107">        customer.status = CustomerStatus.INACTIVE; // 默认未激活状态</span>
<span class="fc" id="L108">        customer.points = 0; // 默认积分为0</span>
<span class="fc" id="L109">        customer.level = 1; // 默认等级为1</span>
<span class="fc" id="L110">        customer.createDate = DateTimeUtils.getCurrentDate();</span>
<span class="fc" id="L111">        customer.lastUpdateDate = DateTimeUtils.getCurrentDate();</span>
        
        // 注册领域事件
<span class="fc" id="L114">        customer.registerEvent(new BrandCustomerCreatedEvent(id, brandId, personId, customerCode));</span>
        
<span class="fc" id="L116">        return customer;</span>
    }
    
    /**
     * 激活顾客
     */
    public void activate() {
<span class="fc bfc" id="L123" title="All 2 branches covered.">        if (status.isActive()) {</span>
<span class="fc" id="L124">            return; // 已经是激活状态，无需重复激活</span>
        }
        
<span class="fc" id="L127">        CustomerStatus oldStatus = this.status;</span>
<span class="fc" id="L128">        this.status = CustomerStatus.ACTIVE;</span>
<span class="fc" id="L129">        this.lastUpdateDate = DateTimeUtils.getCurrentDate();</span>
        
<span class="fc" id="L131">        registerEvent(new BrandCustomerStatusChangedEvent(this.id, oldStatus, this.status));</span>
<span class="fc" id="L132">    }</span>
    
    /**
     * 冻结顾客
     * 
     * @param reason 冻结原因
     */
    public void freeze(String reason) {
<span class="fc" id="L140">        Assert.notEmpty(reason, &quot;冻结原因不能为空&quot;);</span>
        
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (status.isFrozen()) {</span>
<span class="nc" id="L143">            return; // 已经是冻结状态，无需重复冻结</span>
        }
        
<span class="fc" id="L146">        CustomerStatus oldStatus = this.status;</span>
<span class="fc" id="L147">        this.status = CustomerStatus.FROZEN;</span>
<span class="fc" id="L148">        this.lastUpdateDate = DateTimeUtils.getCurrentDate();</span>
        
<span class="fc" id="L150">        registerEvent(new BrandCustomerStatusChangedEvent(this.id, oldStatus, this.status, reason));</span>
<span class="fc" id="L151">    }</span>
    
    /**
     * 解冻顾客
     */
    public void unfreeze() {
<span class="fc bfc" id="L157" title="All 2 branches covered.">        if (!status.isFrozen()) {</span>
<span class="fc" id="L158">            throw new IllegalStateException(&quot;只有冻结状态的顾客才能解冻&quot;);</span>
        }
        
<span class="fc" id="L161">        CustomerStatus oldStatus = this.status;</span>
<span class="fc" id="L162">        this.status = CustomerStatus.ACTIVE;</span>
<span class="fc" id="L163">        this.lastUpdateDate = DateTimeUtils.getCurrentDate();</span>
        
<span class="fc" id="L165">        registerEvent(new BrandCustomerStatusChangedEvent(this.id, oldStatus, this.status));</span>
<span class="fc" id="L166">    }</span>
    
    /**
     * 更新顾客类型
     * 
     * @param customerType 新的顾客类型
     */
    public void updateCustomerType(CustomerType customerType) {
<span class="fc" id="L174">        Assert.notNull(customerType, &quot;顾客类型不能为空&quot;);</span>
        
<span class="fc bfc" id="L176" title="All 2 branches covered.">        if (this.customerType == customerType) {</span>
<span class="fc" id="L177">            return; // 类型没有变化，无需更新</span>
        }
        
<span class="fc" id="L180">        this.customerType = customerType;</span>
<span class="fc" id="L181">        this.lastUpdateDate = DateTimeUtils.getCurrentDate();</span>
        
<span class="fc" id="L183">        registerEvent(new BrandCustomerUpdatedEvent(this.id, &quot;customerType&quot;));</span>
<span class="fc" id="L184">    }</span>
    
    /**
     * 增加积分
     * 
     * @param points 增加的积分数
     */
    public void addPoints(int points) {
<span class="fc bfc" id="L192" title="All 2 branches covered.">        Assert.isTrue(points &gt; 0, &quot;增加的积分必须大于0&quot;);</span>
        
<span class="fc bfc" id="L194" title="All 2 branches covered.">        if (!status.canOperate()) {</span>
<span class="fc" id="L195">            throw new IllegalStateException(&quot;当前状态不允许积分操作&quot;);</span>
        }
        
<span class="fc" id="L198">        this.points += points;</span>
<span class="fc" id="L199">        this.lastUpdateDate = DateTimeUtils.getCurrentDate();</span>
        
        // 根据积分自动升级
<span class="fc" id="L202">        updateLevelByPoints();</span>
        
<span class="fc" id="L204">        registerEvent(new BrandCustomerUpdatedEvent(this.id, &quot;points&quot;));</span>
<span class="fc" id="L205">    }</span>
    
    /**
     * 扣减积分
     * 
     * @param points 扣减的积分数
     */
    public void deductPoints(int points) {
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        Assert.isTrue(points &gt; 0, &quot;扣减的积分必须大于0&quot;);</span>
        
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">        if (!status.canOperate()) {</span>
<span class="nc" id="L216">            throw new IllegalStateException(&quot;当前状态不允许积分操作&quot;);</span>
        }
        
<span class="fc bfc" id="L219" title="All 2 branches covered.">        if (this.points &lt; points) {</span>
<span class="fc" id="L220">            throw new IllegalArgumentException(&quot;积分不足，无法扣减&quot;);</span>
        }
        
<span class="fc" id="L223">        this.points -= points;</span>
<span class="fc" id="L224">        this.lastUpdateDate = DateTimeUtils.getCurrentDate();</span>
        
        // 根据积分自动降级
<span class="fc" id="L227">        updateLevelByPoints();</span>
        
<span class="fc" id="L229">        registerEvent(new BrandCustomerUpdatedEvent(this.id, &quot;points&quot;));</span>
<span class="fc" id="L230">    }</span>
    
    /**
     * 设置等级
     * 
     * @param level 新等级
     */
    public void setLevel(int level) {
<span class="fc bfc" id="L238" title="All 2 branches covered.">        Assert.isTrue(level &gt; 0, &quot;等级必须大于0&quot;);</span>
        
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">        if (this.level == level) {</span>
<span class="nc" id="L241">            return; // 等级没有变化，无需更新</span>
        }
        
<span class="fc" id="L244">        this.level = level;</span>
<span class="fc" id="L245">        this.lastUpdateDate = DateTimeUtils.getCurrentDate();</span>
        
<span class="fc" id="L247">        registerEvent(new BrandCustomerUpdatedEvent(this.id, &quot;level&quot;));</span>
<span class="fc" id="L248">    }</span>
    
    /**
     * 是否可以进行业务操作
     * 
     * @return true-可以操作，false-不可以操作
     */
    public boolean canOperate() {
<span class="fc" id="L256">        return status.canOperate();</span>
    }
    
    /**
     * 是否为VIP顾客
     * 
     * @return true-是VIP顾客，false-不是VIP顾客
     */
    public boolean isVip() {
<span class="fc" id="L265">        return customerType.isVip();</span>
    }
    
    /**
     * 是否为批发顾客
     * 
     * @return true-是批发顾客，false-不是批发顾客
     */
    public boolean isWholesale() {
<span class="fc" id="L274">        return customerType.isWholesale();</span>
    }
    
    /**
     * 是否为衍生关系
     * 
     * @return true-是衍生关系，false-不是衍生关系
     */
    public boolean isDerivedRelation() {
<span class="fc" id="L283">        return relationType.isDerived();</span>
    }
    
    /**
     * 根据积分自动更新等级
     */
    private void updateLevelByPoints() {
<span class="fc" id="L290">        int newLevel = calculateLevelByPoints(this.points);</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">        if (newLevel != this.level) {</span>
<span class="fc" id="L292">            this.level = newLevel;</span>
        }
<span class="fc" id="L294">    }</span>
    
    /**
     * 根据积分计算等级
     * 
     * @param points 积分
     * @return 等级
     */
    private int calculateLevelByPoints(int points) {
        // 简单的等级计算规则，可以根据业务需求调整
<span class="fc bfc" id="L304" title="All 2 branches covered.">        if (points &gt;= 10000) {</span>
<span class="fc" id="L305">            return 5; // 钻石级</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">        } else if (points &gt;= 5000) {</span>
<span class="fc" id="L307">            return 4; // 白金级</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">        } else if (points &gt;= 2000) {</span>
<span class="fc" id="L309">            return 3; // 黄金级</span>
<span class="fc bfc" id="L310" title="All 2 branches covered.">        } else if (points &gt;= 500) {</span>
<span class="fc" id="L311">            return 2; // 银牌级</span>
        } else {
<span class="fc" id="L313">            return 1; // 普通级</span>
        }
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>